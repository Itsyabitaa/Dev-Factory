<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevFactory - Project Scaffolding</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --primary: #0ea5e9;
            --primary-hover: #0284c7;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --border: rgba(51, 65, 85, 0.5);
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Glassmorphism background effect */
        body::before {
            content: '';
            position: absolute;
            top: -10%;
            left: -10%;
            width: 40%;
            height: 40%;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.15) 0%, transparent 70%);
            z-index: -1;
            filter: blur(60px);
        }

        header {
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .system-status {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .dot-green {
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .dot-red {
            background-color: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        main {
            flex: 1;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
        }

        .wizard-container {
            width: 100%;
            max-width: 800px;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 30px;
            font-weight: 600;
        }

        /* Step 1: Frameworks */
        .framework-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .framework-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 30px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 15px;
        }

        .framework-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            background: rgba(30, 41, 59, 0.9);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .framework-card.selected {
            border-color: var(--primary);
            background: rgba(14, 165, 233, 0.1);
            outline: 2px solid var(--primary);
        }

        .framework-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .framework-name {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .framework-desc {
            font-size: 0.9rem;
            color: var(--text-dim);
            line-height: 1.4;
        }

        /* Step 2: Details */
        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        /* Step 3: Progress */
        #log-container {
            background: #000;
            border-radius: 12px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        .log-stdout {
            color: #a3e635;
        }

        .log-stderr {
            color: #f87171;
        }

        .log-step {
            color: #38bdf8;
            font-weight: 700;
            margin-top: 15px;
            display: block;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 600;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Buttons */
        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        button {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: transparent;
            color: var(--danger);
            border-color: var(--danger);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Success screen */
        .success-card {
            text-align: center;
            padding: 40px;
        }

        .success-icon {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 20px;
        }

        .project-path {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            margin: 20px 0;
            word-break: break-all;
        }

        /* Sprint 5 ‚Äî Dashboard */
        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .nav-links a {
            color: var(--text-dim);
            text-decoration: none;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 8px;
        }
        .nav-links a:hover, .nav-links a.active {
            color: var(--primary);
        }
        .nav-links a.active {
            background: rgba(14, 165, 233, 0.15);
        }
        .project-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .project-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .project-row .name { font-weight: 600; flex: 0 0 160px; }
        .project-row .framework { color: var(--text-dim); flex: 0 0 100px; font-size: 0.9rem; }
        .project-row .url { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--primary); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; }
        .project-row .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-stopped { background: rgba(148, 163, 184, 0.2); color: var(--text-dim); }
        .status-running { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .status-starting { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-error { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .logs-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 280px;
            background: #0c1222;
            border-top: 1px solid var(--border);
            display: none;
            flex-direction: column;
            z-index: 100;
        }
        .logs-panel.open { display: flex; }
        .logs-panel-header {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logs-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .dep-error-row {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">DevFactory</div>
        <div style="display: flex; align-items: center; gap: 24px;">
            <nav class="nav-links">
                <a href="#" id="nav-create" class="active" onclick="showView('view-framework'); document.querySelectorAll('.nav-links a').forEach(a=>a.classList.remove('active')); document.getElementById('nav-create').classList.add('active'); return false;">Create Project</a>
                <a href="#" id="nav-projects" onclick="showView('view-dashboard'); loadDashboard(); document.querySelectorAll('.nav-links a').forEach(a=>a.classList.remove('active')); document.getElementById('nav-projects').classList.add('active'); return false;">Projects</a>
                <a href="#" id="nav-system-check" onclick="showView('view-system-check'); loadSystemCheck(); document.querySelectorAll('.nav-links a').forEach(a=>a.classList.remove('active')); document.getElementById('nav-system-check').classList.add('active'); return false;">System Check</a>
            </nav>
            <div id="proxy-status" class="proxy-status-wrap" style="display: flex; align-items: center; gap: 8px;">
                <span id="proxy-badge" class="status-item" title="Local proxy for http://*.test"><span class="status-dot dot-red"></span> Proxy: <span id="proxy-state">Stopped</span></span>
                <button type="button" class="btn-secondary" id="proxy-start-btn" style="padding: 6px 12px; font-size: 0.85rem;">Start Proxy</button>
                <button type="button" class="btn-secondary" id="proxy-stop-btn" style="padding: 6px 12px; font-size: 0.85rem;" disabled>Stop Proxy</button>
                <button type="button" class="btn-secondary" id="proxy-repair-btn" style="padding: 6px 12px; font-size: 0.85rem;" title="Rebuild proxy routes from projects">Repair</button>
                <span id="proxy-error" style="color: var(--danger); font-size: 0.8rem; max-width: 180px; overflow: hidden; text-overflow: ellipsis;" title=""></span>
            </div>
            <button type="button" class="btn-secondary" id="export-logs-btn" style="padding: 6px 12px; font-size: 0.85rem;">Export Logs</button>
            <div class="system-status" id="dep-status"></div>
        </div>
    </header>

    <main>
        <div class="wizard-container">

            <!-- Step 1: Framework Choice -->
            <div id="view-framework" class="view active">
                <h2>Choose Framework</h2>
                <div class="framework-grid">
                    <div class="framework-card" onclick="selectFramework('laravel')">
                        <div class="framework-icon">üêò</div>
                        <div class="framework-name">Laravel</div>
                        <div class="framework-desc">PHP framework for web artisans. Needs Composer & PHP.</div>
                    </div>
                    <div class="framework-card" onclick="selectFramework('react')">
                        <div class="framework-icon">‚öõÔ∏è</div>
                        <div class="framework-name">React (Vite)</div>
                        <div class="framework-desc">Modern React with lightning fast Vite build tool.</div>
                    </div>
                    <div class="framework-card" onclick="selectFramework('next')">
                        <div class="framework-icon">‚ñ≤</div>
                        <div class="framework-name">Next.js</div>
                        <div class="framework-desc">The React framework for the web. Full-stack power.</div>
                    </div>
                    <div class="framework-card" onclick="selectFramework('angular')">
                        <div class="framework-icon">üÖ∞Ô∏è</div>
                        <div class="framework-name">Angular</div>
                        <div class="framework-desc">The modern web developer's platform. Official CLI.</div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Project Details -->
            <div id="view-details" class="view">
                <h2 id="details-title">Project Details</h2>
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="project-name" placeholder="my-awesome-app">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <div class="input-wrapper">
                        <input type="text" id="project-path" readonly placeholder="Click Browse to select...">
                        <button class="btn-secondary" onclick="browseFolder()">Browse</button>
                    </div>
                </div>
                <div class="form-group" id="preset-group" style="display: none;">
                    <label>Preset / Template</label>
                    <select id="project-preset" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
                        <option value="">Default</option>
                    </select>
                </div>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" id="opt-deps" checked> Install dependencies after creation
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="opt-git" checked> Initialize git repository
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="opt-domain" checked onchange="updateDomainPreview()">
                        Create domain mapping (<span id="domain-preview"
                            style="color:var(--primary); font-weight:700;"></span>)
                    </label>
                </div>
                <div class="actions">
                    <button class="btn-secondary" onclick="showView('view-framework')">Back</button>
                    <button class="btn-primary" onclick="startScaffolding()">Create Project</button>
                </div>
            </div>

            <!-- Step 3: Progress -->
            <div id="view-progress" class="view">
                <h2>Scaffolding Project...</h2>
                <div class="progress-indicator">
                    <div class="spinner"></div>
                    <span id="current-step">Initialising...</span>
                </div>
                <div id="log-container"></div>
                <div class="actions">
                    <button class="btn-danger" id="cancel-btn" onclick="cancelProject()">Cancel Process</button>
                </div>
            </div>

            <div id="view-success" class="view">
                <div class="success-card">
                    <div class="success-icon">‚úì</div>
                    <h2>Project Created Successfully!</h2>
                    <p>Your new project is ready to go.</p>
                    <div class="project-path" id="final-path"></div>
                    <div id="domain-status" style="margin-bottom: 20px; display: none;">
                        <span style="color: var(--text-dim);">Domain Mapping:</span>
                        <span id="final-domain" style="color: var(--success); font-weight: 700;"></span>
                        <span id="v-badge"
                            style="background: var(--success); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 10px;">VERIFIED</span>
                    </div>
                    <div class="actions" style="justify-content: center; border:none; margin-top:0;">
                        <button class="btn-secondary" onclick="openFolder()">Open Folder</button>
                        <button class="btn-primary" onclick="openInCode()">Open in VS Code</button>
                    </div>
                    <div style="margin-top: 30px;">
                        <button class="btn-secondary" onclick="resetWizard()">Create Another Project</button>
                    </div>
                </div>
            </div>

            <!-- Sprint 5: Project Dashboard (Sprint 8: search, sort, import) -->
            <div id="view-dashboard" class="view">
                <h2>Projects</h2>
                <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 16px; margin-bottom: 20px;">
                    <button type="button" class="btn-primary" onclick="importProject()">Import Project</button>
                    <input type="text" id="dashboard-search" placeholder="Search projects..." style="max-width: 200px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
                    <select id="dashboard-sort" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
                        <option value="name">Sort by name</option>
                        <option value="framework">Sort by framework</option>
                        <option value="lastOpened">Last opened</option>
                    </select>
                </div>
                <ul id="project-list" class="project-list"></ul>
                <p id="dashboard-empty" style="color: var(--text-dim); display: none;">No projects yet. Create one or Import Project.</p>
            </div>

            <!-- Sprint 7: System Check -->
            <div id="view-system-check" class="view">
                <h2>System Check</h2>
                <p style="color: var(--text-dim); margin-bottom: 20px;">Required tools for scaffolding and running projects.</p>
                <ul id="system-check-list" class="project-list" style="max-width: 560px;"></ul>
                <div style="margin-top: 24px;">
                    <p style="color: var(--text-dim); margin-bottom: 12px;">Install guides:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="window.electronAPI.serverOpenUrl('https://nodejs.org/')">How to install Node.js</button>
                        <button type="button" class="btn-secondary" onclick="window.electronAPI.serverOpenUrl('https://getcomposer.org/doc/00-intro.md')">How to install Composer</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Sprint 8: Run profile modal -->
    <div id="run-profile-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 480px; width: 90%;">
            <h3 style="margin-top: 0;">Edit run profile</h3>
            <p style="color: var(--text-dim); font-size: 0.9rem;">Override how this project is started. Use <code>{{port}}</code> for the port.</p>
            <div class="form-group">
                <label>Port</label>
                <input type="number" id="run-profile-port" placeholder="e.g. 3000" min="1" max="65535" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
            </div>
            <div class="form-group">
                <label>Start command (optional)</label>
                <input type="text" id="run-profile-command" placeholder="e.g. npm run dev -- -p {{port}}" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button type="button" class="btn-primary" onclick="saveRunProfile()">Save</button>
                <button type="button" class="btn-secondary" onclick="closeRunProfileModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Sprint 5: Live logs panel -->
    <div id="logs-panel" class="logs-panel">
        <div class="logs-panel-header">
            <span id="logs-panel-title">Server log</span>
            <button class="btn-secondary" onclick="closeLogsPanel()">Close</button>
        </div>
        <div id="logs-panel-content" class="logs-panel-content"></div>
    </div>

    <script>
        // Simple ANSI to HTML converter
        class AnsiConverter {
            constructor() {
                this.colors = {
                    0: '#f8fafc', // Reset
                    31: '#f87171', // Red
                    32: '#4ade80', // Green
                    33: '#fbbf24', // Yellow
                    34: '#60a5fa', // Blue
                    35: '#c084fc', // Magenta
                    36: '#22d3ee', // Cyan
                    37: '#e2e8f0', // White
                    90: '#94a3b8', // Gray
                };
            }

            toHtml(text) {
                // Escape HTML
                let html = text.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                // Replace ANSI codes
                const ansiRegex = /\u001b\[(\d+;?\d*)m/g;
                let currentAttributes = [];

                html = html.replace(ansiRegex, (match, code) => {
                    const codes = code.split(';');
                    let result = '';

                    codes.forEach(c => {
                        const numericCode = parseInt(c);
                        if (numericCode === 0) {
                            while (currentAttributes.length > 0) {
                                currentAttributes.pop();
                                result += '</span>';
                            }
                        } else if (this.colors[numericCode]) {
                            result += `<span style="color: ${this.colors[numericCode]}">`;
                            currentAttributes.push('color');
                        }
                    });

                    return result;
                });

                while (currentAttributes.length > 0) {
                    currentAttributes.pop();
                    html += '</span>';
                }

                return html.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            }
        }

        const ansiConverter = new AnsiConverter();
        let selectedFramework = null;
        let finalProjectPath = '';
        let domainSuffix = '.test';

        // Initial dependency check
        async function checkDeps() {
            const deps = await window.electronAPI.checkDeps();
            const container = document.getElementById('dep-status');
            container.innerHTML = '';

            deps.forEach(dep => {
                const item = document.createElement('div');
                item.className = 'status-item';
                item.title = dep.installed ? dep.version : (dep.error || 'Not found');
                item.innerHTML = `
                    <div class="status-dot ${dep.installed ? 'dot-green' : 'dot-red'}"></div>
                    ${dep.tool.toUpperCase()}
                `;
                container.appendChild(item);
            });
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            if (id === 'view-details') {
                updateDomainPreview();
            }
        }

        async function selectFramework(fw) {
            selectedFramework = fw;
            document.querySelectorAll('.framework-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('details-title').textContent = `Project Details: ${fw.charAt(0).toUpperCase() + fw.slice(1)}`;
            const presetGroup = document.getElementById('preset-group');
            const presetSelect = document.getElementById('project-preset');
            const presets = await window.electronAPI.presetsForFramework(fw);
            presetSelect.innerHTML = '<option value="">Default</option>';
            if (presets && presets.length > 0) {
                presetGroup.style.display = 'block';
                presets.forEach(pr => presetSelect.appendChild(new Option(pr.label, pr.id)));
            } else presetGroup.style.display = 'none';
            showView('view-details');
        }

        function updateDomainPreview() {
            const name = document.getElementById('project-name').value.trim() || 'my-app';
            const domain = name.toLowerCase().replace(/[^a-z0-9]/g, '-') + domainSuffix;
            document.getElementById('domain-preview').textContent = domain;
        }

        // Attach listener to project name input
        document.getElementById('project-name').addEventListener('input', updateDomainPreview);

        async function browseFolder() {
            const path = await window.electronAPI.selectDir();
            if (path) {
                document.getElementById('project-path').value = path;
            }
        }

        function resetWizard() {
            selectedFramework = null;
            document.getElementById('project-name').value = '';
            document.getElementById('project-path').value = '';
            document.getElementById('log-container').innerHTML = '';
            document.getElementById('domain-status').style.display = 'none';
            showView('view-framework');
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            const navCreate = document.getElementById('nav-create');
            if (navCreate) navCreate.classList.add('active');
        }

        function appendLog(data, type) {
            const container = document.getElementById('log-container');
            if (data) {
                if (type === 'stdout' || type === 'stderr') {
                    const html = ansiConverter.toHtml(data);
                    const div = document.createElement('div');
                    div.style.display = 'inline';
                    div.innerHTML = html;
                    container.appendChild(div);
                } else {
                    const span = document.createElement('span');
                    span.className = `log-${type}`;
                    span.textContent = data;
                    container.appendChild(span);
                }
            }
            container.scrollTop = container.scrollHeight;
        }

        async function startScaffolding() {
            const name = document.getElementById('project-name').value.trim();
            const path = document.getElementById('project-path').value.trim();

            if (!name || !path) {
                alert('Please provide a project name and location.');
                return;
            }

            if (!/^[a-zA-Z0-9-]+$/.test(name)) {
                alert('Project name can only contain letters, numbers, and hyphens.');
                return;
            }

            finalProjectPath = `${path}/${name}`;
            const domain = name.toLowerCase().replace(/[^a-z0-9]/g, '-') + domainSuffix;
            const shouldMapDomain = document.getElementById('opt-domain').checked;

            showView('view-progress');
            document.getElementById('log-container').innerHTML = '';

            const presetId = document.getElementById('project-preset')?.value || undefined;
            const payload = {
                framework: selectedFramework,
                name,
                path,
                options: {
                    installDeps: document.getElementById('opt-deps').checked,
                    initGit: document.getElementById('opt-git').checked
                },
                presetId
            };

            const response = await window.electronAPI.createProject(payload);

            if (response.success) {
                document.getElementById('final-path').textContent = finalProjectPath;

                if (shouldMapDomain) {
                    const isFrontend = selectedFramework === 'react' || selectedFramework === 'next' || selectedFramework === 'angular';
                    if (isFrontend) {
                        appendLog(`\nBuilding for production (so ${domain} works right away)...\n`, 'log-step');
                        document.getElementById('current-step').textContent = 'Building for production...';
                        const buildRes = await window.electronAPI.buildProject(finalProjectPath, selectedFramework);
                        if (buildRes.success) {
                            appendLog(`Build completed.\n`, 'stdout');
                        } else {
                            appendLog(`Build failed (you can run "npm run build" in the project later).\n`, 'stderr');
                        }
                    }
                    appendLog(`\nMapping domain ${domain} (Admin permission required)...\n`, 'log-step');
                    document.getElementById('current-step').textContent = 'Mapping domain...';
                    const documentRoot = await window.electronAPI.getDocumentRoot(finalProjectPath, selectedFramework, name);
                    const domainRes = await window.electronAPI.addDomain(domain, name, documentRoot);
                    if (domainRes.success) {
                        document.getElementById('domain-status').style.display = 'block';
                        document.getElementById('final-domain').textContent = domain;
                        appendLog(`Domain ${domain} mapped successfully!\n`, 'stdout');
                    } else {
                        appendLog(`Failed to map domain: ${domainRes.error}\n`, 'stderr');
                    }
                }

                showView('view-success');
            } else {
                appendLog(`\nFAILED: ${response.error}\n`, 'stderr');
                document.getElementById('current-step').textContent = 'Failed';
                document.getElementById('cancel-btn').textContent = 'Back to Start';
                document.getElementById('cancel-btn').onclick = resetWizard;
            }
        }

        function cancelProject() {
            window.electronAPI.cancelCommand('all');
            resetWizard();
        }

        function openFolder() {
            window.electronAPI.openFolder(finalProjectPath);
        }

        function openInCode() {
            window.electronAPI.openCode(finalProjectPath);
        }

        window.electronAPI.onProjectProgress((info) => {
            if (info.type === 'step') {
                document.getElementById('current-step').textContent = info.step;
            }
            appendLog(info.data, info.type);
        });

        // Sprint 5 ‚Äî Dashboard
        const projectStatusMap = {};
        let logsPanelProjectId = null;

        let runProfileModalProjectId = null;
        async function loadDashboard() {
            const list = document.getElementById('project-list');
            const empty = document.getElementById('dashboard-empty');
            let projects = await window.electronAPI.getProjectList();
            if (!projects) projects = [];
            const search = (document.getElementById('dashboard-search')?.value || '').toLowerCase();
            if (search) projects = projects.filter(p => (p.name || '').toLowerCase().includes(search) || (p.framework || '').toLowerCase().includes(search));
            const sortBy = document.getElementById('dashboard-sort')?.value || 'name';
            if (sortBy === 'name') projects.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            else if (sortBy === 'framework') projects.sort((a, b) => (a.framework || '').localeCompare(b.framework || ''));
            else if (sortBy === 'lastOpened') projects.sort((a, b) => (b.lastOpenedAt || '').localeCompare(a.lastOpenedAt || ''));
            list.innerHTML = '';
            if (projects.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';
            for (const p of projects) {
                const status = projectStatusMap[p.fullPath] ?? (await window.electronAPI.serverStatus(p.fullPath));
                projectStatusMap[p.fullPath] = status;
                const url = await window.electronAPI.serverUrl(p.fullPath);
                const row = document.createElement('li');
                row.className = 'project-row';
                row.dataset.projectId = p.fullPath;
                const fwLabel = { laravel: 'Laravel', react: 'React', next: 'Next.js', angular: 'Angular' }[p.framework] || p.framework;
                row.innerHTML = `
                    <span class="name">${escapeHtml(p.name)}</span>
                    <span class="framework">${escapeHtml(fwLabel)}</span>
                    <span class="status-badge status-${status.toLowerCase()}" data-status>${status}</span>
                    <span class="url" title="${escapeHtml(url || '')}">${escapeHtml(url || '‚Äî')}</span>
                    <div class="actions">
                        <button class="btn-primary" data-action="start" ${status === 'Running' || status === 'Starting' ? 'disabled' : ''}>Start</button>
                        <button class="btn-danger" data-action="stop" ${status !== 'Running' && status !== 'Starting' ? 'disabled' : ''}>Stop</button>
                        <button class="btn-secondary" data-action="restart" ${status !== 'Running' && status !== 'Starting' ? 'disabled' : ''}>Restart</button>
                        <button class="btn-secondary" data-action="open" ${!url ? 'disabled' : ''}>Open</button>
                        <button class="btn-secondary" data-action="open-domain" ${!(p.domain) ? 'disabled data-no-domain' : ''} title="${p.domain ? 'Open http://' + escapeHtml(p.domain) + ' (proxy)' : 'Map a domain in Create Project'}">Open Domain</button>
                        <button class="btn-secondary" data-action="logs">View Logs</button>
                        <button class="btn-secondary" data-action="folder">Folder</button>
                        <button class="btn-secondary" data-action="git-init" title="Initialize Git">Git init</button>
                        <button class="btn-secondary" data-action="run-profile" title="Edit start command/port">Run profile</button>
                        <button class="btn-danger" data-action="delete" title="Remove from list and hosts">Delete</button>
                    </div>
                    <div class="dep-error-row" data-dep-error style="display: none; width: 100%; margin: 0; grid-column: 1 / -1;">
                        <span data-dep-msg></span>
                        <button class="btn-primary" data-action="install">Run Install</button>
                    </div>
                `;
                row.querySelector('[data-action="start"]').onclick = () => startProject(p.fullPath, p.framework, p.name, row);
                row.querySelector('[data-action="stop"]').onclick = () => stopProject(p.fullPath, row);
                row.querySelector('[data-action="restart"]').onclick = () => restartProject(p.fullPath, row);
                row.querySelector('[data-action="open"]').onclick = () => openProjectUrl(p.fullPath);
                row.querySelector('[data-action="open-domain"]').onclick = () => openDomainUrl(p.domain);
                row.querySelector('[data-action="logs"]').onclick = () => openLogsPanel(p.fullPath, p.name);
                row.querySelector('[data-action="folder"]').onclick = () => {
                    window.electronAPI.projectUpdate(p.fullPath, { lastOpenedAt: new Date().toISOString() });
                    window.electronAPI.openFolder(p.fullPath);
                };
                row.querySelector('[data-action="git-init"]').onclick = () => runGitInit(p.fullPath, row);
                row.querySelector('[data-action="run-profile"]').onclick = () => openRunProfileModal(p.fullPath, p.name);
                row.querySelector('[data-action="delete"]').onclick = () => deleteProject(p.fullPath, row);
                row.querySelector('[data-action="install"]').onclick = () => runInstall(p.fullPath, row);
                list.appendChild(row);
            }
            attachDashboardSearchSort();
        }
        function attachDashboardSearchSort() {
            const searchEl = document.getElementById('dashboard-search');
            const sortEl = document.getElementById('dashboard-sort');
            if (searchEl) searchEl.oninput = () => loadDashboard();
            if (sortEl) sortEl.onchange = () => loadDashboard();
        }

        function escapeHtml(s) {
            if (s == null) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        async function startProject(projectId, framework, name, rowEl) {
            const depCheck = await window.electronAPI.serverCheckRuntimeDeps(projectId, framework);
            if (!depCheck.ok) {
                const errBox = rowEl.querySelector('[data-dep-error]');
                const msg = rowEl.querySelector('[data-dep-msg]');
                if (errBox && msg) { msg.textContent = depCheck.error; errBox.style.display = 'flex'; }
                return;
            }
            rowEl.querySelector('[data-dep-error]').style.display = 'none';
            window.electronAPI.projectUpdate(projectId, { lastOpenedAt: new Date().toISOString() });
            const res = await window.electronAPI.serverStart(projectId);
            if (!res.success) alert(res.error || 'Start failed');
            else updateRowStatus(rowEl, 'Starting');
        }

        async function stopProject(projectId, rowEl) {
            await window.electronAPI.serverStop(projectId);
            updateRowStatus(rowEl, 'Stopped');
        }

        async function restartProject(projectId, rowEl) {
            const res = await window.electronAPI.serverRestart(projectId);
            if (!res.success) alert(res.error || 'Restart failed');
            else updateRowStatus(rowEl, 'Starting');
        }

        function updateRowStatus(rowEl, status) {
            projectStatusMap[rowEl.dataset.projectId] = status;
            const badge = rowEl.querySelector('[data-status]');
            if (badge) { badge.textContent = status; badge.className = 'status-badge status-' + status.toLowerCase(); }
            const startBtn = rowEl.querySelector('[data-action="start"]');
            const stopBtn = rowEl.querySelector('[data-action="stop"]');
            const restartBtn = rowEl.querySelector('[data-action="restart"]');
            if (startBtn) startBtn.disabled = status === 'Running' || status === 'Starting';
            if (stopBtn) stopBtn.disabled = status !== 'Running' && status !== 'Starting';
            if (restartBtn) restartBtn.disabled = status !== 'Running' && status !== 'Starting';
            refreshRowUrl(rowEl);
        }

        async function refreshRowUrl(rowEl) {
            const projectId = rowEl.dataset.projectId;
            const url = await window.electronAPI.serverUrl(projectId);
            const urlEl = rowEl.querySelector('.url');
            if (urlEl) { urlEl.textContent = url || '‚Äî'; urlEl.title = url || ''; }
            const openBtn = rowEl.querySelector('[data-action="open"]');
            if (openBtn) openBtn.disabled = !url;
        }

        async function openProjectUrl(projectId) {
            const url = await window.electronAPI.serverUrl(projectId);
            if (url) {
                window.electronAPI.projectUpdate(projectId, { lastOpenedAt: new Date().toISOString() });
                window.electronAPI.serverOpenUrl(url);
            }
        }

        async function openDomainUrl(domain) {
            if (!domain) return;
            const url = await window.electronAPI.proxyDomainUrl(domain);
            if (url) window.electronAPI.serverOpenUrl(url);
        }

        function openLogsPanel(projectId, name) {
            logsPanelProjectId = projectId;
            document.getElementById('logs-panel-title').textContent = `Logs: ${name}`;
            document.getElementById('logs-panel-content').innerHTML = '';
            document.getElementById('logs-panel').classList.add('open');
        }

        function closeLogsPanel() {
            logsPanelProjectId = null;
            document.getElementById('logs-panel').classList.remove('open');
        }

        async function runInstall(projectPath, rowEl) {
            showView('view-progress');
            document.getElementById('log-container').innerHTML = '';
            document.getElementById('current-step').textContent = 'Installing dependencies...';
            const res = await window.electronAPI.projectInstall(projectPath);
            if (res.success) {
                rowEl.querySelector('[data-dep-error]').style.display = 'none';
                alert('Dependencies installed.');
            } else alert(res.error || 'Install failed');
            showView('view-dashboard');
            loadDashboard();
        }

        window.electronAPI.onServerStatus((data) => {
            const { projectId, status } = data;
            projectStatusMap[projectId] = status;
            const row = Array.from(document.querySelectorAll('.project-row')).find(r => r.dataset.projectId === projectId);
            if (row) updateRowStatus(row, status);
        });

        window.electronAPI.onServerLog((data) => {
            if (data.projectId !== logsPanelProjectId) return;
            const content = document.getElementById('logs-panel-content');
            if (!content) return;
            const span = document.createElement('span');
            span.style.color = data.type === 'stderr' ? '#f87171' : '#a3e635';
            span.textContent = data.data;
            content.appendChild(span);
            content.scrollTop = content.scrollHeight;
        });

        // Sprint 6 ‚Äî Proxy UI
        let proxyStatusState = 'Stopped';
        function updateProxyUI(status, error) {
            proxyStatusState = status;
            const stateEl = document.getElementById('proxy-state');
            const badge = document.getElementById('proxy-badge');
            const startBtn = document.getElementById('proxy-start-btn');
            const stopBtn = document.getElementById('proxy-stop-btn');
            const errEl = document.getElementById('proxy-error');
            if (stateEl) stateEl.textContent = status;
            if (badge) {
                const dot = badge.querySelector('.status-dot');
                if (dot) {
                    dot.className = 'status-dot ' + (status === 'Running' ? 'dot-green' : status === 'Error' ? 'dot-red' : 'dot-red');
                }
            }
            if (startBtn) startBtn.disabled = status === 'Running';
            if (stopBtn) stopBtn.disabled = status !== 'Running';
            if (errEl) { errEl.textContent = error || ''; errEl.title = error || ''; }
            document.querySelectorAll('.project-row [data-action="open-domain"]').forEach(btn => {
                if (!btn.hasAttribute('data-no-domain')) btn.disabled = status !== 'Running';
            });
        }
        async function refreshProxyStatus() {
            const res = await window.electronAPI.proxyStatus();
            updateProxyUI(res.status, res.error);
        }
        document.getElementById('proxy-start-btn').addEventListener('click', async () => {
            const res = await window.electronAPI.proxyStart();
            if (!res.success) alert(res.error || 'Failed to start proxy');
            await refreshProxyStatus();
        });
        document.getElementById('proxy-stop-btn').addEventListener('click', async () => {
            await window.electronAPI.proxyStop();
            await refreshProxyStatus();
        });
        document.getElementById('proxy-repair-btn').addEventListener('click', async () => {
            const res = await window.electronAPI.proxyRepair();
            if (res.success) alert(res.message || 'Proxy routes repaired.');
            else alert(res.error || 'Repair failed');
        });
        window.electronAPI.onProxyStatus((data) => updateProxyUI(data.status, data.error));

        document.getElementById('export-logs-btn').addEventListener('click', async () => {
            const res = await window.electronAPI.logsExportToFile();
            if (res && res.success) alert('Logs saved to ' + res.path);
            else if (res && !res.success) { /* cancelled */ }
            else alert('Export failed');
        });

        async function loadSystemCheck() {
            const deps = await window.electronAPI.checkDeps();
            const list = document.getElementById('system-check-list');
            list.innerHTML = '';
            deps.forEach(dep => {
                const li = document.createElement('li');
                li.className = 'project-row';
                li.innerHTML = `
                    <span class="name">${dep.tool.toUpperCase()}</span>
                    <span class="status-badge status-${dep.installed ? 'running' : 'error'}">${dep.installed ? 'Found' : 'Not found'}</span>
                    ${dep.error ? '<span style="color:var(--text-dim);">' + escapeHtml(dep.error) + '</span>' : ''}
                `;
                list.appendChild(li);
            });
        }

        async function deleteProject(projectId, rowEl) {
            if (!confirm('Remove this project from DevFactory? This will stop the server (if running), remove the proxy route, and remove the hosts entry. The project folder is not deleted.')) return;
            const res = await window.electronAPI.projectDelete(projectId);
            if (res.success) rowEl.remove();
            else alert(res.error || 'Delete failed');
        }
        async function importProject() {
            const res = await window.electronAPI.projectImport();
            if (res.success) { loadDashboard(); alert(`Imported as ${res.framework}.`); }
            else alert(res.error || 'Import failed');
        }
        async function runGitInit(projectPath, rowEl) {
            showView('view-progress');
            document.getElementById('current-step').textContent = 'Git init...';
            document.getElementById('log-container').innerHTML = '';
            const res = await window.electronAPI.projectGitInit(projectPath);
            if (res.success) alert('Git initialized.');
            else alert(res.error || 'Git init failed');
            showView('view-dashboard');
            loadDashboard();
        }
        function openRunProfileModal(projectId, name) {
            runProfileModalProjectId = projectId;
            document.getElementById('run-profile-modal').style.display = 'flex';
            window.electronAPI.getProject(projectId).then(p => {
                const rp = p?.runProfile;
                document.getElementById('run-profile-port').value = rp?.port ?? '';
                document.getElementById('run-profile-command').value = rp?.startCommand ?? '';
            });
        }
        function closeRunProfileModal() {
            runProfileModalProjectId = null;
            document.getElementById('run-profile-modal').style.display = 'none';
        }
        async function saveRunProfile() {
            if (!runProfileModalProjectId) return;
            const portVal = document.getElementById('run-profile-port').value;
            const port = portVal ? parseInt(portVal, 10) : undefined;
            const startCommand = document.getElementById('run-profile-command').value.trim() || undefined;
            await window.electronAPI.projectUpdate(runProfileModalProjectId, { runProfile: { port, startCommand } });
            closeRunProfileModal();
            loadDashboard();
        }

        checkDeps();
        refreshProxyStatus();
    </script>
</body>

</html>